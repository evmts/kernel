<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: terminal/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: terminal/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Web3os Terminal
 * @class Web3osTerminal
 * @extends Terminal
 * @property {string} cmd - The current user input
 * @property {string} cwd - The current working directory
 * @property {object} env - The terminal's environment variables
 * @property {boolean} debug - Enable verbose output
 * @property {object} aliases - Map of command aliases
 */

import path from 'path'
import colors from 'ansi-colors'
import escapes from 'ansi-escape-sequences'
import { Terminal } from 'xterm'
import { FitAddon } from 'xterm-addon-fit'
import { AttachAddon } from 'xterm-addon-attach'
import { WebLinksAddon } from 'xterm-addon-web-links'

import 'xterm/css/xterm.css'
import { term } from '..'

let defaults = {
  convertEol: true,
  cursorBlink: true,
  macOptionIsMeta: true,
  fontSize: 16
}

class Web3osTerminal extends Terminal {
  cmd = ''
  cwd = '/'
  env = {}
  debug = false
  aliases = {}
  history = []
  binSearchPath = []
  customCommands = []
  cursorPosition = 0
  historyPosition = 0
  promptFormat = `&lt;${colors.cyan('3os')}>${colors.blue('{cwd}')}${colors.green('#')} `

  escapes = escapes

  constructor (options = {}) {
    super(options) // 🦸‍♂️⚙
    this.kernel = options.kernel || globalThis.Kernel
    this.customCommands = options.customCommands || []
    this.binSearchPath = options.binSearchPath || ['@web3os-core', '@web3os-fs', '@web3os-apps', '@web3os-utils']
    this.debug = options.debug || false
    this.log = this.log.bind(this)
    if (this.debug) console.log('New Terminal Created:', this, { options, kernel: this.kernel })

    this.customCommands.push({
      name: 'env',
      run: (term, context) => {
        const [key, value] = context.split(' ')
        if (this.debug) console.log('ENV:', { key, value })
        if (value) this.env[key] = isNaN(value) ? value : parseFloat(value)

        if (key) term.log(this.env[key])
        else term.log(this.env)

        term.prompt()
      }
    })
  }

  log (...args) {
    for (let arg of args) {
      arg = typeof arg === 'string' ? arg : JSON.stringify(arg, null, 2)
      if (arg) this.writeln(arg)
    }

    return args
  }

  promptCompile () {
    return this.promptFormat.replace(/\{cwd\}/g, colors.muted(this.cwd))
  }
  
  prompt (value) {
    if (value) this.promptFormat = value
    this.write(this.promptCompile())
    this.listen()
  }

  async paste (data) {
    const clip = data ? data : await navigator.clipboard.readText()
    this.write(clip)
    this.cmd += clip
  }

  isPrintable (domEvent) {
    const code = domEvent.which
    if (!code) return false

    return !domEvent.altKey &amp;&amp; !domEvent.ctrlKey &amp;&amp; !domEvent.metaKey &amp;&amp;
      (
        code >= 32 &amp;&amp; code &lt;= 126 ||
        code >= 186 &amp;&amp; code &lt;= 192 ||
        code >= 219 &amp;&amp; code &lt;= 222 ||
        [173].includes(code)
      )
  }

  async keyHandler ({ key, domEvent }) {
    if (!key) return
    const keyName = domEvent.key
    const printable = this.isPrintable(domEvent)
    const cursorPosition = this.cursorPosition
    const cmd = this.cmd

    if (this.debug) console.log({ cursorPosition, cmd, keyName, domEvent, key, printable })

    if (domEvent.ctrlKey) {
      switch (keyName.toLowerCase()) {
        case 'v':
          return await this.paste()
        case 'c':
          if (this.getSelection() === '') {
            this.cmd = ''
            this.write('^C\n')
            this.cursorPosition = 0
            this.historyPosition = 0
            return this.prompt()
          }

          return await navigator.clipboard.writeText(this.getSelection())
        default:
          return
      }
    }

    switch (keyName) {
      case 'Enter':
        this.write('\n')
        this.unlisten()

        if (this.cmd.trim().length > 0) {
          this.interruptListener = this.onKey(this.interruptHandler.bind(this))
          this.history.push(this.cmd)

          let exec = this.aliases[this.cmd] ? this.aliases[this.cmd] : this.cmd
          const options = { terminal: this, doPrompt: true }

          const customCommand = this.customCommands?.find(c => c.name === this.cmd.split(' ')[0])
          if (customCommand) customCommand.run(this, this.cmd.split(' ').slice(1).join(' '))
          else {
            if (this.cwd.match(/^\/bin\/.+/)) {
              const scopedBin = path.join(this.cwd, this.cmd)
              if (this.kernel.fs.existsSync(scopedBin)) {
                this.kernel.execute(scopedBin.replace('/bin/', ''), options)
              } else {
                this.kernel.execute(exec, options)
              }
            } else {
              const searchPaths = [...this.cwd, ...this.binSearchPath.map(p => `/bin/${p}`)]
              const match = searchPaths.find(p => p !== '/' &amp;&amp; this.kernel.fs.existsSync(`${p}/${exec.split(' ')[0]}`))
              if (match) exec = path.join(`${match}/${exec.split(' ')[0]}`) + ' ' + exec.split(' ').slice(1).join(' ')
              this.kernel.execute(exec, options)
            }
          }
        } else {
          return this.prompt()
        }

        this.cmd = ''
        this.cursorPosition = 0
        this.historyPosition = 0
        break
      case 'Delete':
        if (this.cursorPosition === this.cmd.length) break
        this.cmd = `${this.cmd.slice(0, this.cursorPosition)}${this.cmd.slice(this.cursorPosition + 1)}`
        this.write(escapes.erase.inLine())
        this.write(this.cmd.slice(this.cursorPosition))
        if (this.cmd.length > this.cursorPosition) this.write(escapes.cursor.back(this.cmd.length - this.cursorPosition))
        break
      case 'Backspace':
        if (this.cursorPosition === 0) break
        this.cursorPosition--
        this.write(escapes.cursor.back())
        this.cmd = `${this.cmd.slice(0, this.cursorPosition)}${this.cmd.slice(this.cursorPosition + 1)}`
        this.write(escapes.erase.inLine())
        this.write(this.cmd.slice(this.cursorPosition))
        if (this.cmd.length > this.cursorPosition) this.write(escapes.cursor.back(this.cmd.length - this.cursorPosition))
        break
      case 'ArrowLeft':
        if (this.cursorPosition === 0) break
        this.cursorPosition--
        this.write(key)
        break
      case 'ArrowRight':
        if (this.cursorPosition >= this.cmd.length) break
        this.cursorPosition++
        this.write(key)
        break
      case 'ArrowUp':
        if (this.history.length > 0) this.historyPosition += 1
        if (this.historyPosition > this.history.length) this.historyPosition = 0
        if (this.historyPosition === 0 &amp;&amp; this.cmd.length > 0) {
          this.cmd = ''
          this.write(escapes.cursor.back(this.cursorPosition))
          this.write(escapes.erase.inLine())
          this.cursorPosition = 0
          break
        }

        const previousCommand = this.history[this.historyPosition - 1]
        if (previousCommand) {
          if (this.cursorPosition > 0) this.write(escapes.cursor.back(this.cmd.length))
          this.write(escapes.erase.inLine())
          this.write(previousCommand)
          this.cmd = previousCommand
          this.cursorPosition = this.cmd.length
        } else {
          this.historyPosition = 0
        }

        break
      case 'ArrowDown':
        if (this.history.length > 0) this.historyPosition -= 1
        if (this.historyPosition &lt; 0) this.historyPosition = this.history.length
        if (this.historyPosition === 0 &amp;&amp; this.cmd.length > 0) {
          this.cmd = ''
          this.write(escapes.cursor.back(this.cursorPosition))
          this.write(escapes.erase.inLine())
          this.cursorPosition = 0
          break
        }

        const nextCommand = this.history[this.historyPosition - 1]
        if (nextCommand) {
          if (this.cursorPosition > 0) this.write(escapes.cursor.back(this.cmd.length))
          this.write(escapes.erase.inLine())
          this.write(nextCommand)
          this.cmd = nextCommand
          this.cursorPosition = this.cmd.length
        } else {
          this.historyPosition = 0
        }

        break
      case 'Home':
        if (this.cursorPosition === 0) break
        this.write(escapes.cursor.back(this.cursorPosition))
        this.cursorPosition = 0
        break
      case 'End':
        if (this.cursorPosition === this.cmd.length) break
        if (this.cursorPosition > 0) this.write(escapes.cursor.back(this.cursorPosition))
        this.write(escapes.cursor.forward(this.cmd.length))
        this.cursorPosition = this.cmd.length
        break
      case 'Escape':
        this.cmd = ''
        this.cursorPosition = 0
        this.setOption('cursorStyle', 'block')
        this.writeln('')
        this.prompt()
        break
      case 'Insert':
        this.setOption('cursorStyle', this.getOption('cursorStyle') === 'block' ? 'underline' : 'block')
        break
      case 'PageUp':
        this.scrollPages(-1)
        break
      case 'PageDown':
        this.scrollPages(1)
        break
      default:
        if (printable) {
          const replaceMode = this.getOption('cursorStyle') === 'underline'
          const remainderOffset = replaceMode &amp;&amp; this.cursorPosition &lt; this.cmd.length ? this.cursorPosition + 1: this.cursorPosition
          this.cmd = `${this.cmd.slice(0, this.cursorPosition)}${key}${this.cmd.slice(remainderOffset)}`
          const remainder = this.cmd.slice(remainderOffset)

          this.cursorPosition++
          this.write(escapes.erase.inLine())
          this.write(replaceMode &amp;&amp; (this.cmd.length > this.cursorPosition || remainder === '') ? key + remainder : remainder)
          if (this.cmd.length > this.cursorPosition) this.write(escapes.cursor.back(this.cmd.length - this.cursorPosition))
        }
    }
  }

  // This doesn't actually kill anything, but it will return access to the terminal
  interruptHandler ({ key, domEvent }) {
    if (!key) return
    const keyName = domEvent.key

    if (
      keyName === 'Escape'
      || domEvent.ctrlKey &amp;&amp; keyName.toLowerCase() === 'c'
    ) {
      this.interruptListener.dispose()
      this.historyPosition = 0
      this.cursorPosition = 0
      this.cmd = ''
      this.write('^C\n')
      return this.prompt()
    }
  }

  listen () {
    this.unlisten()
    this.keyListener = this.onKey(this.keyHandler.bind(this))

    // TODO: Get mobile keyboard to work
    // this.textarea.onkeyup = e => {
    //   if (e.key === 'Unidentified') return
    //   console.log({ up: e })
    //   this.keyHandler({ key: e.key, domEvent: e })
    // }

    // A little workaround: optimistically assume any data over one character is a paste
    // TODO: Also catch other paste events
    this.pasteListener = this.onData(data => {
      const containsUnprintable = data.split('').some(char => !this.isPrintable(data))
      data.length > 1 &amp;&amp; !containsUnprintable &amp;&amp; this.paste()
    })
  }

  unlisten () {
    try {
      this.keyListener.dispose()
      this.pasteListener.dispose()
      this.interruptListener.dispose()
    } catch {}
  }
}

export function create (options = {}) {
  const term = new Web3osTerminal({ ...defaults, ...options })
  const fitAddon = new FitAddon()

  term.loadAddon(fitAddon)
  term.loadAddon(new WebLinksAddon())
  if (options.socket) {
    const attachAddon = new AttachAddon(options.socket)
    term.loadAddon(attachAddon)
  }

  term.fit = fitAddon.fit.bind(fitAddon)
  return term
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-_loader.html">_loader</a></li></ul><h3>Classes</h3><ul><li><a href="Web3osTerminal.html">Web3osTerminal</a></li></ul><h3>Global</h3><ul><li><a href="global.html#builtinModules">builtinModules</a></li><li><a href="global.html#deleteKey">deleteKey</a></li><li><a href="global.html#deleteNamespace">deleteNamespace</a></li><li><a href="global.html#dump">dump</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#loadLocalStorage">loadLocalStorage</a></li><li><a href="global.html#log">log</a></li><li><a href="global.html#modules">modules</a></li><li><a href="global.html#restore">restore</a></li><li><a href="global.html#set">set</a></li><li><a href="global.html#showBootIntro">showBootIntro</a></li><li><a href="global.html#updateLocalStorage">updateLocalStorage</a></li><li><a href="global.html#utils">utils</a></li><li><a href="global.html#windows">windows</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Thu Jun 02 2022 11:38:02 GMT-0500 (Central Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
