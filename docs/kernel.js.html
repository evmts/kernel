<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Adding favicon -->
    

    <!-- Adding meta -->
    

    <!-- Adding external script-->
    

    <!-- Adding external style-->
    

    <!-- Adding scripts-->
    

    <!-- Adding style-->
    

    <!-- Adding overlay script-->
    

    <!-- Adding overlay style-->
    


    <title>
      Web3os API Reference: kernel.js
    </title>

    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/third-party/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/third-party/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/reset.css">
    <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-base.css">
    <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-dark.css">
    
    <svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
    style="display:none">
    <defs>
        <symbol id="copy-icon" viewbox="0 0 488.3 488.3">
            <g>
                <path
                    d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z" />
                <path
                    d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z" />
            </g>
        </symbol>
        <symbol id='search-icon' viewBox="0 0 512 512">
            <g>
                <g>
                    <path
                        d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z" />
                </g>
            </g>
            <g>
                <g>
                    <path
                        d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z" />
                </g>
            </g>
        </symbol>
        <symbol id="down-icon" viewBox="0 0 16 16">
            <path 
                fill-rule="evenodd" 
                clip-rule="evenodd" 
                d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"
            >
            </path>
        </symbol>
    </defs>
</svg>
  </head>

  <body>

    <nav class="navbar" id="navbar">
      
          <a href="index.html"><img class="navbar-logo" src="http://github.com/web3os-org/kernel/raw/master/.github/iconlogo.png" /></a>
          <div class="navbar-heading" id="navbar-heading"><a href="index.html"><h2 class="navbar-heading-text">API Reference</h2></a></div>
          <div class="navbar-badges">
            <a class="navbar-badge" href="https://web3os.sh" target="_blank">
              <img alt="Launch web3os.sh" src="https://img.shields.io/badge/launch-web3os.sh-blue?style=for-the-badge" style="max-width: 100%;"></a>
            <a class="navbar-badge" href="https://github.com/web3os-org/kernel">
              <img alt="View Source" src="https://img.shields.io/badge/repo-web3os%E2%80%94org%2Fkernel-silver?style=for-the-badge&logo=github" />
            </a>
          </div>
        <div class="search-box" id="search-box"><div class="search-box-input-container"><input class="search-box-input" type="text" placeholder="Search..." id="search-box-input" /><svg class="search-icon" alt="search-icon"><use xlink:href="#search-icon"></use></svg></div><div class="search-item-container" id="search-item-container"><ul class="search-item-ul" id="search-item-ul"></ul></div></div><div class="sidebar-main-content" id="sidebar-main-content"><div class="accordion collapsed" id="2726019" > <h3 class="accordion-heading">Modules<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion collapsed child" id=215558><div class="accordion-heading child"><a href="module-@web3os-core_3pm.html">@web3os-core/3pm</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="module-@web3os-core_3pm.html#.install">install</a></li><li data-type='method'><a href="module-@web3os-core_3pm.html#.run">run</a></li><li data-type='method'><a href="module-@web3os-core_3pm.html#.uninstall">uninstall</a></li></ul></li><li class="accordion-list" id=""><a href="module-@web3os-core__loader.html">@web3os-core/_loader</a></li><li class="accordion-list" id=""><a href="module-@web3os-core_account.html">@web3os-core/account</a></li><li class="accordion-list" id=""><a href="module-@web3os-core_peer.html">@web3os-core/peer</a></li></ul> </div><div class="accordion collapsed" id="6915964" > <h3 class="accordion-heading">Classes<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion collapsed child" id=4534887><div class="accordion-heading child"><a href="Web3osTerminal.html">Web3osTerminal</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="Web3osTerminal.html#.create">create</a></li><li data-type='method'><a href="Web3osTerminal.html#acceptTabSelection">acceptTabSelection</a></li><li data-type='method'><a href="Web3osTerminal.html#cancelTabSelection">cancelTabSelection</a></li><li data-type='method'><a href="Web3osTerminal.html#interruptHandler">interruptHandler</a></li><li data-type='method'><a href="Web3osTerminal.html#isPrintable">isPrintable</a></li><li data-type='method'><a href="Web3osTerminal.html#keyHandler">keyHandler</a></li><li data-type='method'><a href="Web3osTerminal.html#listen">listen</a></li><li data-type='method'><a href="Web3osTerminal.html#log">log</a></li><li data-type='method'><a href="Web3osTerminal.html#paste">paste</a></li><li data-type='method'><a href="Web3osTerminal.html#prompt">prompt</a></li><li data-type='method'><a href="Web3osTerminal.html#promptCompile">promptCompile</a></li><li data-type='method'><a href="Web3osTerminal.html#tabCompletion">tabCompletion</a></li><li data-type='method'><a href="Web3osTerminal.html#unlisten">unlisten</a></li></ul></li></ul> </div><div class="accordion collapsed" id="590915" > <h3 class="accordion-heading">Tutorials<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion-list" id=""><a href="tutorial-connect-your-wallet.html">Connect your wallet</a></li></ul> </div><div class="accordion collapsed" id="4913577" > <h3 class="accordion-heading">Kernel<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion-list" id=""><a href="global.html#autostart">autostart</a></li><li class="accordion-list" id=""><a href="global.html#boot">boot</a></li><li class="accordion-list" id=""><a href="global.html#broadcast">broadcast</a></li><li class="accordion-list" id=""><a href="global.html#builtinModules">builtinModules</a></li><li class="accordion-list" id=""><a href="global.html#colorChars">colorChars</a></li><li class="accordion-list" id=""><a href="global.html#deleteKey">deleteKey</a></li><li class="accordion-list" id=""><a href="global.html#deleteNamespace">deleteNamespace</a></li><li class="accordion-list" id=""><a href="global.html#dialog">dialog</a></li><li class="accordion-list" id=""><a href="global.html#download">download</a></li><li class="accordion-list" id=""><a href="global.html#dump">dump</a></li><li class="accordion-list" id=""><a href="global.html#events">events</a></li><li class="accordion-list" id=""><a href="global.html#execute">execute</a></li><li class="accordion-list" id=""><a href="global.html#executeScript">executeScript</a></li><li class="accordion-list" id=""><a href="global.html#fs">fs</a></li><li class="accordion-list" id=""><a href="global.html#get">get</a></li><li class="accordion-list" id=""><a href="global.html#importModuleUrl">importModuleUrl</a></li><li class="accordion-list" id=""><a href="global.html#importUMDModule">importUMDModule</a></li><li class="accordion-list" id=""><a href="global.html#loadLocalStorage">loadLocalStorage</a></li><li class="accordion-list" id=""><a href="global.html#loadModule">loadModule</a></li><li class="accordion-list" id=""><a href="global.html#loadPackages">loadPackages</a></li><li class="accordion-list" id=""><a href="global.html#log">log</a></li><li class="accordion-list" id=""><a href="global.html#modules">modules</a></li><li class="accordion-list" id=""><a href="global.html#notify">notify</a></li><li class="accordion-list" id=""><a href="global.html#registerBuiltinModules">registerBuiltinModules</a></li><li class="accordion-list" id=""><a href="global.html#registerKernelBins">registerKernelBins</a></li><li class="accordion-list" id=""><a href="global.html#restore">restore</a></li><li class="accordion-list" id=""><a href="global.html#set">set</a></li><li class="accordion-list" id=""><a href="global.html#setupFilesystem">setupFilesystem</a></li><li class="accordion-list" id=""><a href="global.html#showBootIntro">showBootIntro</a></li><li class="accordion-list" id=""><a href="global.html#showSplash">showSplash</a></li><li class="accordion-list" id=""><a href="global.html#snackbar">snackbar</a></li><li class="accordion-list" id=""><a href="global.html#systemNotify">systemNotify</a></li><li class="accordion-list" id=""><a href="global.html#updateLocalStorage">updateLocalStorage</a></li><li class="accordion-list" id=""><a href="global.html#upload">upload</a></li><li class="accordion-list" id=""><a href="global.html#utils">utils</a></li><li class="accordion-list" id=""><a href="global.html#wait">wait</a></li><li class="accordion-list" id=""><a href="global.html#windows">windows</a></li></ul> </div>
      

    </nav>
    <div class="navbar-ham" id="navbar-ham">
      <div>
        <div class="first"></div>
        <div class="second"></div>
        <div class="third"></div>
      </div>
    </div>

    <div id="main" class="main-content">
      
      <h1 id='page-title' class="page-title">
        kernel.js
      </h1>
      

      



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Web3os Kernel
 * 
 * @description Entrypoint of the web3os kernel
 * @author Jay Mathis &lt;code@mathis.network>
 * @license MIT
 * @see https://github.com/web3os-org/kernel
 */

/* global Kernel, Terminal, System */
/* global fetch, File, FileReader, localStorage, location, Notification */

import rootPkgJson from '../package.json'

import AwesomeNotifications from 'awesome-notifications'
import bytes from 'bytes'
import colors from 'ansi-colors'
import columnify from 'columnify'
import CustomEvent from 'custom-event-js'
import figlet from 'figlet'
import figletFont from 'figlet/importable-fonts/Graffiti'
import path from 'path'
import sweetalert from 'sweetalert2'
import topbar from 'topbar'

import { unzip } from 'unzipit'

import 'systemjs'
import 'animate.css'
import 'awesome-notifications/dist/style.css'
import './css/index.css'
import './themes/default/index.css'
import './themes/default/sweetalert2.css'

import '@material/mwc-button'
import '@material/mwc-icon-button'
import '@material/mwc-snackbar'

import README from '../README.md'
import AppWindow from './windows'
import theme from './themes/default/index.js'

export const version = rootPkgJson.version
const figletFontName = 'Graffiti'
const fsModules = {}
globalThis.topbar = topbar

// TODO: Whittle this down and migrate to packages
/** The array of default builtin modules */
export const builtinModules = [
  '3pm', 'account', 'backend', 'bluetooth', 'confetti', 'contract', 'desktop', 'edit',
  'files', 'help', 'markdown', 'peer', 'ping', 'screensaver',
  'usb', 'view', 'wasm', 'www'
]

export const defaultPackages = [
  'https://unpkg.com/@web3os-apps/doom',
  'https://unpkg.com/@web3os-apps/wolfenstein',
  'https://unpkg.com/@web3os-apps/minipaint',
  'https://unpkg.com/@web3os-apps/rubikscube',
  'https://unpkg.com/@web3os-apps/gun'
]

// TODO: i18n this (and everything else). This doesn't even belong here anymore.
const configDescriptions = {
  'autostart.sh': 'Executed at startup line by line',
  packages: 'Master local package list'
}

/**
 * Contains miscellaneous utilities
 * @type {Object}
 */
export const utils = { path, bytes }

/**
 * Contains all registered kernel modules
 * @type {Object}
 */
export const modules = {}

/**
 * Gives access to the BrowserFS API
 * @type {Object}
 */
export let fs

/**
 * The main kernel event bus
 * 
 * @type {CustomEvent}
 * 
 * @see https://developer.mozilla.org/en-US/docs/Web/API/CustomEvent
 * @see https://www.npmjs.com/package/custom-event-js
 * 
 * @property {Function} dispatch - Dispatch an event
 * @property {string} dispatch.eventName - The name of the event
 * @property {Object} dispatch.detail - The event detail payload
 * @property {Function} on - Subscribe to event
 * @property {string} on.eventName - The name of the event
 * @property {Function} on.callback - Execute when this event is triggered
 * @property {Function} off - Unsubscribe from event
 * @property {string} off.eventName - The name of the event
 * @property {Function} off.callback - Execute when this event is triggered
 */
export const events = CustomEvent

/**
 * The primary Broadcast Channel for web3os
 * 
 * @type {BroadcastChannel}
 * @see https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API
 */
export const broadcast = new BroadcastChannel('web3os')
broadcast.onmessage = msg => {
  console.log('Incoming Broadcast:', msg)
}

let BrowserFS
let memory

const FileSystemOverlayConfig = {
  // AsyncMirror is not the ideal way to handle this, but it works for now
  // until migration from sync to async in the fsModules is complete
  '/': {
    fs: 'AsyncMirror',
    options: {
      sync: { fs: 'InMemory' },
      async: {
        fs: 'IndexedDB',
        options: {
          storeName: 'web3os'
        }
      }
    }
  },

  '/mount/html5fs': {
    fs: 'AsyncMirror',
    options: {
      sync: { fs: 'InMemory' },
      async: {
        fs: 'HTML5FS',
        options: {}
      }
    }
  },

  '/bin': { fs: 'InMemory' },
  '/tmp': { fs: 'InMemory' },
  '/docs': { fs: 'InMemory' },
  '/mount': { fs: 'InMemory' }
}

colors.theme(theme)

/**
 * Output the boot introduction
 * */
export async function showBootIntro () {
  const isSmall = window.innerWidth &lt;= 445
  log(colors.info(`${isSmall ? '' : '\t '}Made with  ${colors.red('♥')}  by Jay Mathis`))
  log(colors.heading.success.bold(`\n${isSmall ? '' : '\t '}    web3os kernel v${rootPkgJson.version}    `))
  log(colors.warning(`${isSmall ? '' : '\t '}⚠           BETA          ⚠`))

  if (navigator.deviceMemory) log(`\n${colors.info('RAM:')} >= ${colors.muted(navigator.deviceMemory + 'GB')}`)
  if (navigator.storage?.estimate) {
    const storageDetails = await navigator.storage.estimate()
    const used = bytes(storageDetails.usage)
    const free = bytes(storageDetails.quota - storageDetails.usage)
    log(`${colors.info('Storage:')} Used: ${colors.muted(used)} - Free: ${colors.muted(free)}`)
  }

  if (navigator.getBattery) {
    const batt = await navigator.getBattery()

    batt.addEventListener('chargingchange', () => {
      if (batt.charging) execute('confetti')
    })

    log(`${colors.info('Battery:')} ${batt.charging ? `${batt.level * 100}% ⚡` : `${batt.level * 100}% 🔋`}`)
  }

  if (navigator.userAgentData) {
    const { brand, version } = navigator.userAgentData.brands.slice(-1)?.[0]
    const browser = `${brand} v${version}`

    Terminal.write(`${colors.info('Browser:')} ${colors.muted(browser)}`)
    Terminal.write(`${isSmall ? '\n' : '\t '}${colors.info('Platform:')} ${colors.muted(navigator.userAgentData.platform || 'Unknown')}\n`)
  }

  if (!localStorage.getItem('web3os_first_boot_complete')) {
    log(colors.danger('\n⚠ The first boot will take the longest, please be patient! ⚠\n'))
  }

  if (navigator.userAgentData.platform === 'Android' || window.innerWidth &lt; 500 || window.innerHeight &lt; 500) {
    log(colors.danger('\n⚠ 🐉  NOTE: The mobile experience is pretty wacky and experimental - proceed with caution! ⚠'))
  }

  log(colors.danger(`\nType ${colors.bold.underline('help')} for help`))
  log(colors.gray(`Type ${colors.bold.underline('markdown /docs/README.md')} to view the README`))
  log(colors.info(`Type ${colors.bold.underline('desktop')} to launch the desktop`))
  log(colors.primary(`Type ${colors.bold.underline('account connect')} to connect your wallet`))
  log(colors.success(`Type ${colors.bold.underline('files /bin')} to explore all executable commands`))
  log(colors.warning(`Type ${colors.bold.underline('lsmod')} to list all kernel modules`))
  log(colors.cyan(`Type ${colors.bold.underline('confetti')} to fire the confetti gun 🎉`))
  log(colors.magenta(`Type ${colors.bold.underline('minipaint')} to draw Art™ 🎨`))
  log(colors.muted(`Type ${colors.bold.underline('clip &lt;command>')} to copy the output of a command to the clipboard\n`))

  log('https://docs.web3os.sh')
  log('https://github.com/web3os-org')
  log(colors.muted('\nBooting...'))
}

/**
 * Write the kernel memory to localStorage
 */
function updateLocalStorage () { localStorage.setItem('memory', JSON.stringify(memory)) }

/**
 * Restore the kernel memory from localStorage
 */
function loadLocalStorage () {
  try {
    const storedMemory = localStorage.getItem('memory')
    if (!storedMemory) memory = { firstBootVersion: rootPkgJson.version }
    else { memory = JSON.parse(storedMemory) }
    updateLocalStorage()
  } catch (err) {
    console.error(err)
    memory = {}
  }
}

/**
 * Set a value in the kernel memory object
 * @param {!string} namespace - The namespace in which to set the value
 * @param {!string} key - The key in which to set the value
 * @param {!string} value - The value to set
 */
export function set (namespace, key, value) {
  if (!namespace || namespace === '') throw new Error('Invalid namespace')
  if (!key || key === '') throw new Error('Invalid key')
  if (!value || value === '') throw new Error('Invalid value')
  memory[namespace] = memory[namespace] || {}
  memory[namespace][key] = value
  updateLocalStorage()
  return memory[namespace]?.[key]
}

/**
 * Get a value from the kernel memory object
 * @param {!string} namespace - The namespace from which to get the value
 * @param {?string} key - The key to retrieve, or undefined to get entire namespace
 */
export function get (namespace, key) {
  if (!key) return memory[namespace] || null
  return memory[namespace]?.[key] || null
}

/**
 * Dump the kernel memory to a JSON object
 * @returns {string} dump The memory dump
 */
export function dump () { return JSON.stringify(memory) }

/**
 * Restore the kernel memory from a JSON object
 * @param {!string} json - The JSON object generated from dump()
 */
export function restore (json) {
  memory = JSON.parse(json)
  updateLocalStorage()
  return memory
}

/**
 * Delete the specified key from the kernel memory object
 * @param {!string} namespace - The namespace containing the key
 * @param {!key} key - The key to delete
 */
export function deleteKey (namespace, key) {
  if (!memory[namespace]?.[key]) throw new Error('Invalid namespace or key')
  delete memory[namespace][key]
  updateLocalStorage()
}

/**
 * Delete the specified namespace from the kernel memory object
 * @param {!namespace} namespace - The namespace to delete
 */
export function deleteNamespace (namespace) {
  if (!memory[namespace]) throw new Error('Invalid namespace')
  delete memory[namespace]
  updateLocalStorage()
}

/**
 * Log a message to the terminal with a newline
 * @param {!string} message - The message to log
 * @param {?Object} options - Logging options
 * @param {?Boolean} options.console - Enable logging to both browser console and Terminal
 * @param {?Web3osTerminal} options.terminal - The terminal to attach to, or undefined for global Terminal
 */
export function log (msg, options = {}) {
  if (!msg) return
  msg = msg.replace(/\\n/gm, '\n')
  if (options.console) console.log(msg)
  const term = options.terminal || globalThis.Terminal
  term.writeln(msg)
}

/**
 * Manages interactions with the windowing system
 * @type Object
 * @property {Set} _collection - The collection of windows
 *
 * @property {Function} create - Create a new window
 * @property {Object} create.options - Options to pass to WinBox
 *
 * @property {Function} find - Find a window by ID
 * @property {string} find.id - The ID of the window (usually winbox-#; stored on app.window.id)
 */
export const windows = {
  _collection: new Set(),

  create: options => {
    const app = new AppWindow(options)
    windows._collection.add(app)
    return app
  },

  find: id => {
    return Array.from(windows._collection.values()).find(app => app.window.id === id)
  }
}

/**
 * Show a SweetAlert dialog
 * @async
 * @param {Object} options - SweetAlert2 options
 * @returns {SweetAlertDialog}
 */
export async function dialog (options = {}) {
  return sweetalert.fire({
    heightAuto: false,
    denyButtonColor: 'red',
    confirmButtonColor: 'green',
    customClass: { container: 'web3os-kernel-dialog-container' },
    ...options
  })
}

/**
 * Execute a command
 * @async
 * @param {string} cmd - The command to execute
 * @returns {CommandResult}
 */
export async function execute (cmd, options = {}) {
  const exec = cmd.split(' ')[0]
  const term = options.terminal || globalThis.Terminal
  let command = term.aliases[exec] ? modules[term.aliases[exec]] : modules[exec]
  if (options.topbar) topbar.show()

  if (!command) {
    try {
      if (fs.existsSync(exec)) {
        const data = JSON.parse(fs.readFileSync(exec).toString())
        command = modules[data?.name]
      } else {
        command = await import(`./modules/${exec}`)
      }
    } catch (err) {
      console.error(err)
    }
  }

  if (options.topbar) topbar.hide()
  if (!command?.run) { term.log(colors.danger('Invalid command')); return term.prompt() }
  options.doPrompt = options.doPrompt || false

  try {
    if (options.topbar) topbar.show()
    const args = cmd.split(' ').slice(1).join(' ')
    const result = await command.run(term, args)
    if (options.topbar) topbar.hide()
    if (options.doPrompt) term.prompt()
    return result
  } catch (err) {
    console.error(command, err)
    if (err) term.log(err.message || 'An unknown error occurred')
    if (options.doPrompt) term.prompt()
    throw err
  }
}

/**
 * Execute a script file
 * @async
 * @param {string} path - The path of the script
 * @returns {SweetAlertDialog}
 */
export async function executeScript (filename, options = {}) {
  const term = options.terminal || globalThis.Terminal
  if (!filename || filename === '') return term.log(colors.danger('Invalid filename'))
  filename = utils.path.resolve(term.cwd, filename)

  const value = fs.readFileSync(filename, 'utf8')
  const commands = value.split('\n').map(c => c.trim())

  for (const cmd of commands) {
    if (cmd?.trim().length > 0 &amp;&amp; cmd?.[0] !== '#' &amp;&amp; cmd?.substr(0, 2) !== '//') await execute(cmd, { terminal: term, doPrompt: false })
  }
}

/**
 * Execute the /config/autostart.sh script
 * @async
 * @param {string=} defaultAutoStart - Write autostart script with this content if it doesn't exist
 */
export async function autostart (defaultAutoStart = '') {
  try {
    if (!fs.existsSync('/config/autostart.sh')) fs.writeFileSync('/config/autostart.sh', defaultAutoStart) // Setup default autostart.sh
    if (fs.existsSync('/config/autostart.sh')) await executeScript('/config/autostart.sh')
  } catch (err) {
    console.error(err)
    log(colors.danger('Failed to complete autostart script'))
  } finally {
    globalThis.Terminal?.prompt()
  }
}

/**
 * Download a file from web3os to your local PC, or from a URL to web3os
 * @async
 * @param {Web3osTerminal} term - The terminal to attach to
 * @param {string} context - Either a local path to download a file locally, or a URL to download to the current directory
 */
export async function download (term, context) {
  let filename = context
  if (!filename || filename === '') return log(colors.danger('Invalid filename'))

  if (/^(http|ftp|blob)\:/i.test(context) || /^blob/i.test(context)) {
    const url = new URL(context.split(' ')[0])
    filename = utils.path.parse(url.pathname).base
    if (context.split(' ')?.[1] &amp;&amp; context.split(' ')[1] !== '') filename = context.split(' ')[1]
    const buffer = await (await fetch(url.href)).arrayBuffer()
    const data = BrowserFS.Buffer.from(buffer)
    console.log({ filename, data })
    fs.writeFileSync(utils.path.resolve(term.cwd, filename), data)
  } else {
    filename = utils.path.resolve(term.cwd, filename)
    const data = fs.readFileSync(filename)
    const file = new File([data], utils.path.parse(filename).base, { type: 'application/octet-stream' })
    const url = URL.createObjectURL(file)
    const link = document.createElement('a')
    link.href = url
    link.download = utils.path.parse(filename).base
    link.click()
  }
}

/**
 * Upload a file from your local PC to web3os
 * @async
 * @param {Web3osTerminal} term - The terminal to attach to
 */
export async function upload (term) {
  const input = document.createElement('input')
  input.setAttribute('type', 'file')
  input.setAttribute('multiple', true)
  input.addEventListener('change', e => {
    const { files } = e.target
    for (const file of files) {
      const reader = new FileReader()

      reader.readAsArrayBuffer(file)
      reader.onload = () => {
        const buffer = BrowserFS.Buffer.from(reader.result)
        const filepath = utils.path.resolve(term.cwd, file.name)
        fs.writeFileSync(filepath, buffer)
        snackbar({ labelText: `Uploaded ${filepath}` })
      }
    }
  })

  input.click()
}

/**
 * Colorize a string to differentiate numbers and letters
 * @todo Move to .utils
 * @param {string} str - The string to colorize
 * @param {Object=} options - Options for colorization
 * @param {Function=} [options.numbers=colors.blue()] - The function to colorize numbers
 * @param {Function=} [options.letters=colors.white()] - The function to colorize letters
 */
export function colorChars (str, options = {}) {
  if (typeof str !== 'string') throw new Error('You must provide a string to colorChars')
  const numbers = options.numbers || colors.blue
  const letters = options.letters || colors.white
  return str.split('').map(c => isNaN(c) ? letters(c) : numbers(c)).join('')
}

/**
 * Send an awesome-notification
 * @type {AwesomeNotifications}
 * @see https://f3oall.github.io/awesome-notifications
 */
export const notify = new AwesomeNotifications({
  position: 'top-right'
})

/**
 * Send a browser/platform notification
 * @async
 * @param {Object=} options - The notification options (Notification API)
 * @see https://developer.mozilla.org/en-US/docs/Web/API/notification
 */
export async function systemNotify (options = {}) {
  if (Notification.permission !== 'granted') throw new Error('Notification permission denied')
  try {
    const notification = new Notification(options.title, options)
  } catch (err) {
    console.warn(err)
    navigator.serviceWorker.ready.then(registration => {
      registration.showNotification('Notification with ServiceWorker')
    })
  }
}

/**
 * Show a snackbar notification
 * 
 * @deprecated
 * This can still be useful I think, but it's being deprecated
 * in favor of awesome-notifications. Should this be removed?
 * 
 * @async
 * @param {Object=} options - The snackbar options
 * @see https://www.npmjs.com/package/@material/mwc-snackbar
 */
export async function snackbar (options = {}) {
  const snack = document.createElement('mwc-snackbar')
  snack.id = options.id || 'snack-' + Math.random()
  snack.leading = options.leading || false
  snack.closeOnEscape || false
  snack.labelText = options.labelText || ''
  snack.stacked = options.stacked || false

  const closeButton = document.createElement('mwc-icon-button')
  closeButton.icon = 'close'
  closeButton.slot = 'dismiss'

  snack.appendChild(closeButton)
  document.body.appendChild(snack)
  snack.show()
}

/**
 * Sets up the filesystem
 * 
 * These parameters can also be provided as a query parameter:
 * 
 * https://web3os.sh/?initfsUrl=https://my.place.com/initfs.zip
 * 
 * Bare minimum, temporary, fs:
 * https://web3os.sh/?mountableFilesystemConfig={ "/": { "fs": "InMemory" }, "/bin": { "fs": "InMemory" } }
 * 
 * @async
 * @param {string=} initfsUrl - URL to a zipped filesystem snapshot
 * @param {MountableFileSystemOptions=} mountableFilesystemConfig - Filesystem configuration object for BrowserFS for customization
 * @see https://jvilk.com/browserfs/2.0.0-beta/index.html
 */
export async function setupFilesystem (initfsUrl, mountableFilesystemConfig) {
  return new Promise(async (resolve, reject) => {
    // const browserfs = await import('c:\\ode\\web3os\\BrowserFS')
    const browserfs = await import('browserfs')
    const filesystem = {}
  
    let initfs
    const bootArgs = new URLSearchParams(globalThis.location.search)
    initfsUrl = initfsUrl || bootArgs.get('initfsUrl')
    mountableFilesystemConfig = initfsUrl || bootArgs.get('mountableFilesystemConfig')
      ? JSON.parse(bootArgs.get('mountableFilesystemConfig')) : FileSystemOverlayConfig
  
    if (bootArgs.has('initfsUrl')) {
      try {
        const result = await dialog({
          title: 'Use initfs?',
          icon: 'warning',
          allowOutsideClick: false,
          allowEscapeKey: false,
          showDenyButton: true,
          showLoaderOnConfirm: true,
          focusDeny: true,
          confirmButtonText: 'Yes',
          html: `
            &lt;p>Do you want to overwrite existing files in your filesystem with the initfs located at:&lt;/p>
            &lt;h4>&lt;a href="${initfsUrl}" target="_blank">${initfsUrl}&lt;/a>&lt;/h4>
            &lt;p>&lt;strong>Be sure you trust the source!&lt;/strong>&lt;/p>
          `,
          preConfirm: async () => {
            try {
              return await unzip(initfsUrl)
            } catch (err) {
              console.error(err)
              globalThis.Terminal?.log(colors.danger(`Failed to unzip initfsUrl at ${initfsUrl}`))
              return true
            }
          }
        })
  
        if (result.isDenied) throw new Error('User rejected using initfs')
        const { entries } = result.value
        initfs = entries
        globalThis.history.replaceState(null, null, '/') // prevent reload with initfs
      } catch (err) {
        globalThis.Terminal?.log(colors.danger('Failed to unzip initfsUrl ' + initfsUrl))
        globalThis.Terminal?.log(colors.danger(err.message))
        console.error(err)
      }
    }
  
    browserfs.install(filesystem)
    browserfs.configure({
      fs: 'MountableFileSystem',
      options: mountableFilesystemConfig
    }, err => {
      if (err) {
        console.error(err)
        log(colors.danger(`Failed to initialize filesystem: ${err.message}`))
      } else {
        BrowserFS = filesystem
        fs = filesystem.require('fs')
  
        // Use an initfs if available
        if (initfs) {
          Object.entries(initfs).forEach(async ([name, entry]) => {
            const filepath = utils.path.join('/', name)
  
            if (entry.isDirectory) !fs.existsSync(filepath) &amp;&amp; fs.mkdirSync(utils.path.join('/', name))
            else {
              const parentDir = utils.path.parse(filepath).dir
              if (!fs.existsSync(parentDir)) fs.mkdirSync(parentDir)
              fs.writeFileSync(filepath, BrowserFS.Buffer.from(await entry.arrayBuffer()))
            }
          })
        }
  
        // Prepare required paths
        if (!fs.existsSync('/var')) fs.mkdirSync('/var')
        if (!fs.existsSync('/var/packages')) fs.mkdirSync('/var/packages')
        if (!fs.existsSync('/config')) fs.mkdirSync('/config')
        if (!fs.existsSync('/config/packages')) fs.writeFileSync('/config/packages', JSON.stringify(defaultPackages))
  
        // Populate /docs
        try {
          const docs = fs.readdirSync('/docs')
          if (docs.length === 0) fs.writeFileSync('/docs/README.md', README)
        } catch {}
  
        // Drag and drop on terminal
        // const dragenter = e => { e.stopPropagation(); e.preventDefault() }
        // const dragover = e => { e.stopPropagation(); e.preventDefault() }
        // const drop = e => {
        //   e.stopPropagation()
        //   e.preventDefault()
        //   const dt = e.dataTransfer
        //   const files = dt.files
  
        //   for (const file of files) {
        //     const reader = new FileReader()
  
        //     reader.readAsArrayBuffer(file)
        //     reader.onload = () => {
        //       const buffer = BrowserFS.Buffer.from(reader.result)
        //       const filepath = utils.path.resolve(terminal.cwd, file.name)
        //       fs.writeFileSync(filepath, buffer)
        //       snackbar({ labelText: `Uploaded ${filepath}` })
        //     }
        //   }
        // }
  
        // terminal.addEventListener('dragenter', dragenter)
        // terminal.addEventListener('dragover', dragover)
        // terminal.addEventListener('drop', drop)
  
        // Setup FS commands
        fsModules.cwd = { description: 'Get the current working directory', run: term => term.log(term.cwd) }
        fsModules.cd = {
          description: 'Change the current working directory',
          run: (term, context) => {
            const newCwd = utils.path.resolve(term.cwd, context)
            if (!fs.existsSync(newCwd)) throw new Error(`cd: ${context}: No such directory`)
            if (!fs.statSync(newCwd).isDirectory()) throw new Error(`cd: ${context}: No such directory`)
            term.cwd = newCwd
          }
        }
  
        fsModules.read = {
          description: 'Read contents of file',
          run: (term, context) => {
            const dir = utils.path.resolve(term.cwd, context)
            if (!fs.existsSync(dir)) throw new Error(`read: ${dir}: No such file`)
            return term.log(fs.readFileSync(dir, 'utf8'))
          }
        }
  
        fsModules.upload = { description: 'Upload files', run: upload }
        fsModules.download = {
          description: 'Download URL to CWD, or download FILE to PC',
          run: download
        }
  
        fsModules.mkdir = {
          description: 'Create a directory',
          run: (term, context) => {
            if (!context || context === '') throw new Error(`mkdir: ${context}: Invalid directory name`)
            fs.mkdirSync(utils.path.resolve(term.cwd, context))
          }
        }
  
        fsModules.rm = {
          description: 'Remove a file',
          run: (term, context) => {
            const target = utils.path.resolve(term.cwd, context)
            if (!context || context === '') throw new Error(`rm: ${context}: Invalid path`)
            if (!fs.existsSync(target)) throw new Error(`rm: ${context}: No such file`)
            if (fs.statSync(target).isDirectory()) throw new Error(`rm: ${context}: Is a directory, use rmdir`)
            fs.unlinkSync(target)
          }
        }
  
        fsModules.rmdir = {
          description: 'Remove a directory and all of its contents',
          run: (term, context) => {
            const target = utils.path.resolve(term.cwd, context)
            if (!context || context === '') throw new Error(`rmdir: ${context}: Invalid path`)
            if (!fs.existsSync(target)) throw new Error(`rmdir: ${context}: No such directory`)
            if (!fs.statSync(target).isDirectory()) throw new Error(`rm: ${context}: Is not a directory, use rm`)
  
            const entries = fs.readdirSync(target)
  
            if (entries.length === 0) {
              return
            }
  
            for (const entry of entries) {
              const entryPath = utils.path.join(target, entry)
              const entryStat = fs.statSync(entryPath)
              if (entryStat.isDirectory()) fsModules.rmdir.run(term, entryPath)
              else fs.unlinkSync(entryPath)
            }
  
            console.log({ emptyDirs })
          }
        }
  
        fsModules.mv = {
          description: 'Move a file or directory',
          run: (term, context) => {
            const [fromStr, toStr] = context.split(' ')
            const from = utils.path.resolve(term.cwd, fromStr)
            const to = utils.path.resolve(term.cwd, toStr)
            if (!fs.existsSync(from)) throw new Error(`mv: source ${from} does not exist`)
            if (fs.existsSync(to)) throw new Error(`mv: target ${to} already exists`)
            fs.renameSync(from, to)
          }
        }
  
        fsModules.cp = {
          description: 'Copy a file or directory',
          run: (term, context) => {
            const [fromStr, toStr] = context.split(' ')
            const from = utils.path.resolve(term.cwd, fromStr)
            const to = utils.path.resolve(term.cwd, toStr)
            if (!fs.existsSync(from)) throw new Error(`cp: source ${from} does not exist`)
            if (fs.existsSync(to)) throw new Error(`cp: target ${to} already exists`)
            fs.copySync(from, to)
          }
        }
  
        fsModules.ls = {
          description: 'List directory contents',
          run: (term, context) => {
            if (!context || context === '') context = term.cwd
            const entries = fs.readdirSync(utils.path.resolve(term.cwd, context)).sort()
            const data = []
  
            entries.forEach(entry => {
              const filename = utils.path.resolve(term.cwd, context, entry)
              const stat = fs.statSync(filename)
  
              const isNamespacedBin = stat.isFile() &amp;&amp; /^\/bin\/.+\//.test(filename)
  
              // console.log({ entry, filename, context, stat, isNamespacedBin })
  
              const info = modules[filename.replace('/bin/', '')]
              if (isNamespacedBin &amp;&amp; context !== 'bin') {
                data.push({
                  name: colors.cyanBright(entry),
                  description: colors.muted(info.description?.substr(0, 75) || '')
                })
              }
  
              // Show custom output for special dirs
              switch (utils.path.resolve(context)) {
                case '/bin':
                  data.push({
                    name: colors.cyanBright(entry),
                    description: colors.muted(
                      stat.isDirectory()
                        ? `Packages in the ${entry} namespace`
                        : (modules[filename.replace('/bin/', '')]?.description?.substr(0, 50) || '')
                    )
                  })
  
                  break
                case '/config':
                  data.push({
                    name: colors.cyanBright(entry),
                    size: colors.muted(bytes(stat.size).toLowerCase()),
                    description: colors.muted(configDescriptions[entry] || '')
                  })
  
                  break
                default:
                  if (!isNamespacedBin) {
                    data.push({
                      name: stat.isDirectory() ? colors.green('/' + entry) : colors.blue(entry),
                      type: colors.muted.em(stat.isDirectory() ? 'dir' : 'file'),
                      size: colors.muted(bytes(stat.size).toLowerCase())
                    })
                  }
              }
            })
  
            return term.log(columnify(data, {
              config: {
                name: { minWidth: 20 },
                type: { minWidth: 8 },
                size: { minWidth: 8 }
              }
            }))
          }
        }
  
        // FS command aliases
        fsModules.cat = { description: 'Alias of read', run: fsModules.read.run }
        fsModules.dir = { description: 'Alias of ls', run: fsModules.ls.run }
        fsModules.rename = { description: 'Alias of mv', run: fsModules.mv.run }

        resolve(fs)
      }
    })
  })
}

/**
 * Load the kernel's core internal commands
 * 
 * These are here because they're relatively simple, but many of them should be
 * moved to their own respective external modules.
 * 
 * @async
 */
async function registerKernelBins () {
  const kernelBins = []
  kernelBins.alert = { description: 'Show an alert', run: (term, context) => dialog({ text: context }) }
  kernelBins.clear = { description: 'Clear the terminal', run: term => term.clear() }
  kernelBins.docs = { description: 'Open the documentation', run: term => { modules.www.run(term, '--title "Web3os Documentation" --no-toolbar /docs') }}
  kernelBins.dump = { description: 'Dump the memory state', run: term => term.log(dump()) }
  kernelBins.echo = { description: 'Echo some text to the terminal', run: (term, context) => term.log(context) }
  kernelBins.history = { description: 'Show command history', run: term => { return term.log(JSON.stringify(term.history)) } }
  kernelBins.import = { description: 'Import a module from a URL', run: async (term, context) => await importModuleUrl(context) }
  kernelBins.man = { description: 'Alias of help', run: (term, context) => modules.help.run(term, context) }
  kernelBins.sh = { description: 'Execute a web3os script', run: (term, context) => executeScript(context, { terminal: term }) }
  kernelBins.storage = { description: 'Display storage usage information', run: async term => term.log(await navigator.storage.estimate()) }
  kernelBins.systemnotify = { description: 'Show a browser/platform notification with &lt;title> and &lt;body>', run: (term, context) => systemNotify({ title: context.split(' ')[0], body: context.split(' ')[1] }) }
  kernelBins.reboot = { description: 'Reload web3os', run: () => location.reload() }
  kernelBins.restore = { description: 'Restore the memory state', run: (term, context) => restore(context) }
  kernelBins.snackbar = { description: 'Show a snackbar with &lt;message>', run: (term, context) => snackbar({ labelText: context }) }
  kernelBins.wait = { description: 'Wait for the specified number of milliseconds', run: (term, context) => wait(context) }

  kernelBins.alias = {
    description: 'Set or list command aliases',
    help: 'Usage: alias [src] [dest]',
    run: (term, context) => {
      if (!context || context === '') return term.log(term.aliases)
      const command = context.split(' ')
      if (command.length !== 2) throw new Error('You must specify the src and dest commands')
      term.aliases[command[0]] = command[1]
    }
  }

  kernelBins.ipecho = {
    description: 'Echo your public IP address',
    run: async term => {
      const result = await fetch('https://ipecho.net/plain')
      const ip = await result.text()
      console.log({ ip })
      term.log(ip)
      return ip
    }
  }

  kernelBins.lsmod = {
    description: 'List loaded kernel modules',
    run: async term => {
      const mods = {
        ...modules,
        ...module.exports,
        ...exports
      }

      term.log(Object.keys(mods).sort())
      return Object.keys(mods).sort()
    }
  }

  kernelBins.set = {
    description: 'Set a kernel memory value',
    help: 'Usage: set &lt;namespace> &lt;key> &lt;value>',
    run: (term, context = '') => {
      const parts = context.split(' ')
      const namespace = parts[0]
      const key = parts[1]
      const value = parts.slice(2, parts.length).join(' ')
      term.log(set(namespace, key, value))
    }
  }

  kernelBins.get = {
    description: 'Get a kernel memory namespace or key',
    help: 'Usage: get &lt;namespace> [key]',
    run: (term, context = '') => {
      const parts = context.split(' ')
      const namespace = parts[0]
      const key = parts[1]
      const result = get(namespace, key)
      term.log(typeof result === 'string' ? result : JSON.stringify(result))
    }
  }

  kernelBins.unset = {
    description: 'Delete specified memory namespace or key',
    help: 'Usage: delkey &lt;namespace> [key]',
    run: (term, context = '') => {
      try {
        const parts = context.split(' ')
        if (parts[1]) deleteKey(parts[0], parts[1])
        else deleteNamespace(parts[0])
      } catch (err) {
        console.error(err)
        term.log(colors.danger(err.message))
      }
    }
  }

  kernelBins.eval = {
    description: 'Load and evaluate a Javascript file',
    run: (term, filename) => {
      if (!filename || filename === '') return term.log(colors.danger('Invalid filename'))
      filename = utils.path.resolve(term.cwd, filename)
      const code = fs.readFileSync(filename, 'utf-8')
      eval(code) // eslint-disable-line
    }
  }

  kernelBins.clip = {
    description: 'Copy return value of command to clipboard',
    help: 'Usage: clip &lt;command>',
    run: async (term, context) => {
      if (!context || context === '') return
      const parts = context.split(' ')
      const mod = modules[parts[0]]
      const result = await mod.run(term, parts.splice(1).join(' '))
      return await navigator.clipboard.writeText(JSON.stringify(result, null, 2))
    }
  }

  kernelBins.height = {
    description: 'Set body height',
    run: (term, context) => { document.body.style.height = context }
  }

  kernelBins.width = {
    description: 'Set body width',
    run: (term, context) => { document.body.style.width = context }
  }

  kernelBins.objectUrl = {
    description: 'Create an ObjectURL for a file',
    run: (term, filename) => {
      if (!filename || filename === '') throw new Error('Invalid filename')
      const data = fs.readFileSync(utils.path.join(term.cwd, filename))
      const file = new File([data], utils.path.parse(filename).base, { type: 'application/octet-stream' })
      const url = URL.createObjectURL(file)
      return term.log(url)
    }
  }

  for (const [name, mod] of Object.entries(kernelBins)) {
    loadModule(mod, { name: `@web3os-core/${name}` })
  }
}

/**
 * Load the kernel's core external modules
 * @async
 */
async function registerBuiltinModules () {
  const mods = process.env.BUILTIN_MODULES ? process.env.BUILTIN_MODULES.split(',') : builtinModules

  for (const mod of mods) {
    const modBin = await import(`./modules/${mod}`)
    await loadModule(modBin, { name: `@web3os-core/${mod}` })
  }
}

/**
 * Load a module into the kernel
 * @async
 * @param {!ModInfo} mod - The mod to load
 * @param {Object=} options - Options for loading the module
 */
export async function loadModule (mod, options = {}) {
  if (!mod) throw new Error('Invalid module provided to kernel.loadModule')
  let { description, help, name, run, version, pkgJson } = options
  description = description || mod.description
  version = version || pkgJson?.version || mod.version
  help = help || mod.help || 'Help is not exported from this module'
  name = name || mod.name || 'module_' + Math.random().toString(36).slice(2)
  run = run || mod.run || mod.default
  if (!modules[name]) modules[name] = {}
  modules[name] = { ...modules[name], ...mod, run, name, version, description, help }

  const web3osData = pkgJson?.web3osData

  const modInfo = {
    name,
    version,
    description,
    web3osData,
    help
  }

  if (run) {
    let modBin

    if (name.includes('/')) {
      modBin = utils.path.join('/bin', name.split('/')[0], name.split('/')[1])
      if (!fs.existsSync(`/bin/${name.split('/')[0]}`)) fs.mkdirSync(`/bin/${name.split('/')[0]}`)
    } else {
      modBin = utils.path.join('/bin', name)
    }

    fs.writeFileSync(modBin, JSON.stringify(modInfo, null, 2))
  }
}

/**
 * Directly import an ES module from a URL
 * @async
 * @param {string} url - The URL of the module to import
 * @return {Module}
 */
export async function importModuleUrl (url) {
  return await import(/* webpackIgnore: true */ url)
}

/**
 * Directly import a UMD module from a URL
 * @async
 * @param {string} url - The URL of the module to import
 * @return {Module}
 */
export async function importUMDModule (url, name, module = { exports: {} }) {
  // Dark magic stolen from a lost tome of stackoverflow
  const mod = (Function('module', 'exports', await (await fetch(url)).text())
    .call(module, module, module.exports), module).exports

  mod.default = mod.default || mod
  return mod
}

/**
 * Load or install the packages defined in /config/packages
 * @async
 */
export async function loadPackages () {
  const packages = JSON.parse(fs.readFileSync('/config/packages').toString())
  for await (const pkg of packages) {
    try {
      if (/^(http|ftp).*\:/i.test(pkg)) {
        if (modules?.['3pm']) {
          await modules['3pm'].install(pkg, { warn: false })
        } else {
          const waitFor3pm = async () => {
            if (!modules?.['3pm']) return setTimeout(waitFor3pm, 500)
            await modules['3pm'].install(pkg, { warn: false })
          }

          await waitFor3pm()
        }

        continue
      }

      const pkgJson = JSON.parse(fs.readFileSync(`/var/packages/${pkg}/package.json`))
      const main = pkgJson.web3osData.main || pkgJson.main || 'index.js'
      const type = pkgJson.web3osData.type || 'es'
      const mainUrl = `${pkgJson.web3osData.url}/${main}`

      const mod = type === 'umd'
        ? await importUMDModule(mainUrl)
        : await importModuleUrl(mainUrl)

      await loadModule(mod, pkgJson)
    } catch (err) {
      console.error(err)
      globalThis.Terminal.log(colors.danger(err.message))
    }
  }
}

/**
 * Show the boot splash screen
 * @async
 * @todo Make this more customizable
 * @param {string} msg - The message to display
 * @param {Object=} options - The splash screen options
 */
export async function showSplash (msg, options = {}) {
  document.querySelector('#web3os-splash')?.remove()

  const icon = document.createElement('mwc-icon')
  icon.id = 'web3os-splash-icon'
  icon.style.color = options.iconColor || '#03A062'
  icon.style.fontSize = options.iconFontSize || '10em'
  icon.style.marginTop = '2rem'
  icon.innerText = options.icon || 'hourglass_empty'
  if (!options.disableAnimation) icon.classList.add('animate__animated', 'animate__zoomIn')

  const title = document.createElement('h1')
  title.id = 'web3os-splash-title'
  title.innerHTML = options.title || 'web3os'
  title.style.color = options.titleColor || 'white'
  title.style.margin = 0
  title.style.fontSize = options.titleFontSize || 'clamp(0.5rem, 6rem, 7rem)'
  title.style.fontVariant = 'small-caps'
  title.style.textShadow = '4px 4px 4px #888'
  if (!options.disableAnimation) title.classList.add('animate__animated', 'animate__zoomIn')

  const subtitle = document.createElement('h2')
  subtitle.id = 'web3os-splash-subtitle'
  subtitle.innerHTML = options.subtitle || 'Made with &lt;span class="heart">♥&lt;/span> by Jay Mathis'
  subtitle.style.margin = 0
  subtitle.style.color = options.subtitleColor || '#ccc'
  subtitle.style.fontStyle = options.subtitleFontStyle || 'italic'
  subtitle.querySelector('span.heart').style.color = 'red'
  subtitle.querySelector('span.heart').style.fontSize = '1.5em'
  if (!options.disableAnimation) subtitle.classList.add('animate__animated', 'animate__zoomInDown') &amp;&amp; subtitle.style.setProperty('--animate-delay', '0.5s')

  const background = document.createElement('div')
  background.id = 'web3os-splash-background'
  background.style.backgroundColor = '#121212'
  background.style.position = 'absolute'
  background.style.top = 0
  background.style.left = 0
  background.style.width = '100vw'
  background.style.height = '100vh'
  background.style.zIndex = 100001

  // if (!options.disableVideoBackground) {
  //   const video = document.createElement('video')
  //   const file = (await import('./assets/splash.mp4')).default

  //   video.id = 'web3os-splash-video'
  //   video.src = file
  //   video.muted = true
  //   video.loop = true
  //   video.autoplay = true
  //   video.style.width = '100vw'
  //   video.style.height = '100vh'
  //   video.style.objectFit = 'cover'

  //   background.appendChild(video)
  // }

  const message = document.createElement('h3')
  message.id = 'web3os-splash-message'
  message.style.color = 'silver'
  message.style.fontSize = '2.5rem'
  message.textContent = msg || '💾 Booting... 💾'

  const versionInfo = document.createElement('h4')
  versionInfo.id = 'web3os-splash-version'
  versionInfo.style.color = '#333'
  versionInfo.style.position = 'fixed'
  versionInfo.style.bottom = '0.5rem'
  versionInfo.style.right = '1rem'
  versionInfo.textContent = `v${rootPkgJson.version}`

  const container = document.createElement('div')
  container.id = 'web3os-splash'
  container.style.display = 'flex'
  container.style.position = 'absolute'
  container.style.top = 0
  container.style.left = 0
  container.style.margin = 0
  container.style.flexDirection = 'column'
  container.style.justifyContent = 'center'
  container.style.alignItems = 'center'
  container.style.height = '100vh'
  container.style.width = '100vw'
  container.style.zIndex = 100002
  container.style.backgroundColor = 'rgba(0, 0, 0, 0.5)'

  container.appendChild(title)
  container.appendChild(subtitle)
  container.appendChild(icon)
  container.appendChild(message)
  container.appendChild(versionInfo)

  document.body.appendChild(background)
  document.body.appendChild(container)

  // TODO: Make flexible
  if (!options.disableAnimation) {
    let index = 0
    const icons = ['hourglass_empty', 'hourglass_bottom', 'hourglass_top']

    setTimeout(() => {
      icon.classList.remove('animate__animated', 'animate__zoomIn')
      icon.classList.add('rotating')
    }, 1000)

    setInterval(() => {
      icon.innerText = icons[index]
      index++
      if (!icons[index]) index = 0
    }, 500)
  }

  return () => {
    background.classList.add('animate__animated', 'animate__fadeOut', 'animate__fast')
    container.classList.add('animate__animated', 'animate__fadeOut', 'animate__fast')

    background.addEventListener('animationend', background.remove)
    container.addEventListener('animationend', container.remove)
  }
}

/**
 * Boot the kernel
 * 
 * This kicks off the process of initializing the filesystem, modules, and other components
 * @async
 */
export async function boot () {
  topbar.show()
  const bootArgs = new URLSearchParams(globalThis.location.search)
  globalThis.addEventListener('beforeunload', async () => {
    await showSplash('Rebooting...', { icon: 'autorenew', disableAnimation: true, disableVideoBackground: true })
    document.querySelector('#web3os-splash-icon').classList.add('rotating')
  })

  // TODO: Make nobootsplash settable in config as well as query string
  if (!bootArgs.has('nobootsplash')) {
    events.dispatch('ShowSplash')
    const closeSplash = await showSplash()
    setTimeout(closeSplash, 1500) // Prevent splash flash. The splash is pretty and needs to be seen and validated.
    document.querySelector('#web3os-terminal').style.display = 'block'
    setTimeout(globalThis.Terminal?.fit, 50)
    globalThis.Terminal?.focus()
  } else {
    document.querySelector('#web3os-terminal').style.display = 'block'
    setTimeout(globalThis.Terminal?.fit, 50)
    globalThis.Terminal?.focus()
  }

  setInterval(() => globalThis.Terminal?.fit(), 200)

  const isSmall = window.innerWidth &lt;= 445
  figlet.parseFont(figletFontName, figletFont)
  figlet.text('web3os', { font: figletFontName }, async (err, data) => {
    if (err) log(err)
    if (data &amp;&amp; globalThis.innerWidth >= 768) log(`\n${colors.green.bold(data)}`)
    else log(`\n${colors.green.bold(`${isSmall ? '' : '\t   '}🐉  web3os 🐉`)}`)

    console.log(`%cweb3os %c${rootPkgJson.version}`, `
      font-family: "Lucida Console", Monaco, monospace;
      font-size: 25px;
      letter-spacing: 2px;
      word-spacing: 2px;
      color: #028550;
      font-weight: 700;
      font-style: normal;
      font-variant: normal;
      text-transform: none;`, null)

    console.log('%chttps://github.com/web3os-org/kernel', 'font-size:14px;')
    console.log({ Kernel, Terminal, System })

    await showBootIntro()
    await loadLocalStorage()
    events.dispatch('MemoryLoaded', memory)
    await setupFilesystem()
    events.dispatch('FilesystemLoaded')

    for await (const [name, mod] of Object.entries(fsModules)) loadModule(mod, { name: `@web3os-fs/${name}` })

    await registerKernelBins()
    events.dispatch('KernelBinsLoaded')
    await registerBuiltinModules()
    events.dispatch('BuiltinModulesLoaded')
    await loadPackages()
    events.dispatch('PackagesLoaded')

    // Copy namespaced core modules onto root object
    const web3osCoreNamespaces = ['@web3os-core', '@web3os-fs']
    for (const mod of Object.values(modules)) {
      const [namespace, name] = mod.name.split('/')
      if (web3osCoreNamespaces.includes(namespace)) modules[name] = mod
    }

    // Check for notification permission and request if necessary
    if (Notification?.permission === 'default') Notification.requestPermission()
    if (Notification?.permission === 'denied') log(colors.warning('Notification permission denied'))

    localStorage.setItem('web3os_first_boot_complete', 'true')
    events.dispatch('AutostartStart')
    await autostart()
    events.dispatch('AutostartEnd')
    await execute('confetti --startVelocity 90 --particleCount 150')
    topbar.hide()
    const heartbeat = setInterval(() => navigator.vibrate([200, 50, 200]), 1000)
    setTimeout(() => clearInterval(heartbeat), 5000)
    
    // Expose this globally in case it needs to be cleared externally by an app
    window.blinkyTitleInterval = setInterval(() => {
      document.title = document.title.includes('_') ? 'web3os# ' : 'web3os# _'
    }, 600)

    events.dispatch('BootComplete')
  })
}

/**
 * Wait for the specified number of milliseconds
 * @async
 * @todo Move this to .utils
 * @param {number} ms - The number of milliseconds to wait
 * @return {Module}
 */
export async function wait (ms) {
  return new Promise(resolve => setTimeout(resolve, ms))
}

// Setup screensaver interval
let idleTimer
const resetIdleTime = () => {
  clearTimeout(idleTimer)
  if (!modules.screensaver) return
  idleTimer = setTimeout(() => {
    events.dispatch('ScreensaverStart')
    modules.screensaver.run(globalThis.Terminal, get('user', 'screensaver') || 'matrix')
  }, get('config', 'screensaver-timeout') || get('user', 'screensaver-timeout') || 90000)
}

globalThis.addEventListener('load', resetIdleTime)
globalThis.addEventListener('mousemove', resetIdleTime)
globalThis.addEventListener('keydown', resetIdleTime)
globalThis.addEventListener('keyup', resetIdleTime)
globalThis.addEventListener('keypress', resetIdleTime)
globalThis.addEventListener('pointerdown', resetIdleTime)

globalThis.global = globalThis.global || globalThis

// Register service worker
if ('serviceWorker' in navigator) {
  globalThis.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
  })
}
</code></pre>
        </article>
    </section>




    </div>

    <footer class="footer" id="footer">
      
    </footer>

    <script src="scripts/third-party/prettify.js"></script>
    <script src="scripts/third-party/lang-css.js"></script>
    <script type="text/javascript" src="scripts/misc.js"></script>

    <script>prettyPrint();</script>
    <script src="scripts/linenumber.js"></script>
    <script src="scripts/fix-code-block.js"></script>
    <script src="scripts/fix-navbar.js"></script>
    <script src="scripts/fix-readme-anchors.js"></script>
    
      <script src="scripts/search.js"></script>
      <script src="scripts/third-party/fuse.js"></script>
      <script>
        var list = [{"title":"@web3os-core/3pm","link":"<a href=\"module-@web3os-core_3pm.html\">@web3os-core/3pm</a>"},{"title":"module:@web3os-core/3pm.install","link":"<a href=\"module-@web3os-core_3pm.html#.install\">module:@web3os-core/3pm &rtrif; install</a>"},{"title":"module:@web3os-core/3pm.run","link":"<a href=\"module-@web3os-core_3pm.html#.run\">module:@web3os-core/3pm &rtrif; run</a>"},{"title":"module:@web3os-core/3pm.uninstall","link":"<a href=\"module-@web3os-core_3pm.html#.uninstall\">module:@web3os-core/3pm &rtrif; uninstall</a>"},{"title":"@web3os-core/_loader","link":"<a href=\"module-@web3os-core__loader.html\">@web3os-core/_loader</a>"},{"title":"@web3os-core/account","link":"<a href=\"module-@web3os-core_account.html\">@web3os-core/account</a>"},{"title":"@web3os-core/peer","link":"<a href=\"module-@web3os-core_peer.html\">@web3os-core/peer</a>"},{"title":"Web3osTerminal","link":"<a href=\"Web3osTerminal.html\">Web3osTerminal</a>"},{"title":"Web3osTerminal.create","link":"<a href=\"Web3osTerminal.html#.create\">Web3osTerminal &rtrif; create</a>"},{"title":"Web3osTerminal#acceptTabSelection","link":"<a href=\"Web3osTerminal.html#acceptTabSelection\">Web3osTerminal &rtrif; acceptTabSelection</a>"},{"title":"Web3osTerminal#cancelTabSelection","link":"<a href=\"Web3osTerminal.html#cancelTabSelection\">Web3osTerminal &rtrif; cancelTabSelection</a>"},{"title":"Web3osTerminal#interruptHandler","link":"<a href=\"Web3osTerminal.html#interruptHandler\">Web3osTerminal &rtrif; interruptHandler</a>"},{"title":"Web3osTerminal#isPrintable","link":"<a href=\"Web3osTerminal.html#isPrintable\">Web3osTerminal &rtrif; isPrintable</a>"},{"title":"Web3osTerminal#keyHandler","link":"<a href=\"Web3osTerminal.html#keyHandler\">Web3osTerminal &rtrif; keyHandler</a>"},{"title":"Web3osTerminal#listen","link":"<a href=\"Web3osTerminal.html#listen\">Web3osTerminal &rtrif; listen</a>"},{"title":"Web3osTerminal#log","link":"<a href=\"Web3osTerminal.html#log\">Web3osTerminal &rtrif; log</a>"},{"title":"Web3osTerminal#paste","link":"<a href=\"Web3osTerminal.html#paste\">Web3osTerminal &rtrif; paste</a>"},{"title":"Web3osTerminal#prompt","link":"<a href=\"Web3osTerminal.html#prompt\">Web3osTerminal &rtrif; prompt</a>"},{"title":"Web3osTerminal#promptCompile","link":"<a href=\"Web3osTerminal.html#promptCompile\">Web3osTerminal &rtrif; promptCompile</a>"},{"title":"Web3osTerminal#tabCompletion","link":"<a href=\"Web3osTerminal.html#tabCompletion\">Web3osTerminal &rtrif; tabCompletion</a>"},{"title":"Web3osTerminal#unlisten","link":"<a href=\"Web3osTerminal.html#unlisten\">Web3osTerminal &rtrif; unlisten</a>"},{"title":"connect-your-wallet","link":"connect-your-wallet"},{"title":"autostart","link":"<a href=\"global.html#autostart\">autostart</a>"},{"title":"boot","link":"<a href=\"global.html#boot\">boot</a>"},{"title":"broadcast","link":"<a href=\"global.html#broadcast\">broadcast</a>"},{"title":"builtinModules","link":"<a href=\"global.html#builtinModules\">builtinModules</a>"},{"title":"colorChars","link":"<a href=\"global.html#colorChars\">colorChars</a>"},{"title":"deleteKey","link":"<a href=\"global.html#deleteKey\">deleteKey</a>"},{"title":"deleteNamespace","link":"<a href=\"global.html#deleteNamespace\">deleteNamespace</a>"},{"title":"dialog","link":"<a href=\"global.html#dialog\">dialog</a>"},{"title":"download","link":"<a href=\"global.html#download\">download</a>"},{"title":"dump","link":"<a href=\"global.html#dump\">dump</a>"},{"title":"events","link":"<a href=\"global.html#events\">events</a>"},{"title":"execute","link":"<a href=\"global.html#execute\">execute</a>"},{"title":"executeScript","link":"<a href=\"global.html#executeScript\">executeScript</a>"},{"title":"fs","link":"<a href=\"global.html#fs\">fs</a>"},{"title":"get","link":"<a href=\"global.html#get\">get</a>"},{"title":"importModuleUrl","link":"<a href=\"global.html#importModuleUrl\">importModuleUrl</a>"},{"title":"importUMDModule","link":"<a href=\"global.html#importUMDModule\">importUMDModule</a>"},{"title":"loadLocalStorage","link":"<a href=\"global.html#loadLocalStorage\">loadLocalStorage</a>"},{"title":"loadModule","link":"<a href=\"global.html#loadModule\">loadModule</a>"},{"title":"loadPackages","link":"<a href=\"global.html#loadPackages\">loadPackages</a>"},{"title":"log","link":"<a href=\"global.html#log\">log</a>"},{"title":"modules","link":"<a href=\"global.html#modules\">modules</a>"},{"title":"notify","link":"<a href=\"global.html#notify\">notify</a>"},{"title":"registerBuiltinModules","link":"<a href=\"global.html#registerBuiltinModules\">registerBuiltinModules</a>"},{"title":"registerKernelBins","link":"<a href=\"global.html#registerKernelBins\">registerKernelBins</a>"},{"title":"restore","link":"<a href=\"global.html#restore\">restore</a>"},{"title":"set","link":"<a href=\"global.html#set\">set</a>"},{"title":"setupFilesystem","link":"<a href=\"global.html#setupFilesystem\">setupFilesystem</a>"},{"title":"showBootIntro","link":"<a href=\"global.html#showBootIntro\">showBootIntro</a>"},{"title":"showSplash","link":"<a href=\"global.html#showSplash\">showSplash</a>"},{"title":"snackbar","link":"<a href=\"global.html#snackbar\">snackbar</a>"},{"title":"systemNotify","link":"<a href=\"global.html#systemNotify\">systemNotify</a>"},{"title":"updateLocalStorage","link":"<a href=\"global.html#updateLocalStorage\">updateLocalStorage</a>"},{"title":"upload","link":"<a href=\"global.html#upload\">upload</a>"},{"title":"utils","link":"<a href=\"global.html#utils\">utils</a>"},{"title":"wait","link":"<a href=\"global.html#wait\">wait</a>"},{"title":"windows","link":"<a href=\"global.html#windows\">windows</a>"}];
        var options = 
          setupSearch(list, options)
      </script>
    

    

    

    


  </body>

</html>
